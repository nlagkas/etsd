{% extends "site_base.html" %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}
{% load i18n static %}


{% block head_title %}{% blocktrans with pid=publickey.id %}Public key {{ pid }} detail{% endblocktrans %}{% endblock %}
{% block page_title %}{% blocktrans with pid=publickey.id %}Public key {{ pid }} detail{% endblocktrans %}{% endblock %}
{% block page_content %}

<div class="row">
  <div class="col-md-6">
    <b>{% translate "ID" %}</b>: {{ publickey.id }}<br />
    <b>{% translate "Authority" %}</b>: {{ publickey.authority }}<br />
    <b>{% translate "Status" %}</b>: {{ publickey.get_status_display }}<br />
    <b>{% translate "Created on" %}/by</b>: {{ publickey.created_on }} / {{ publickey.created_by }}<br />
    <b>{% translate "Fingerprint" %}</b> <code>{{ publickey.fingerprint }}</code><br />
    <b>{% translate "Confirmation document" %}</b> <a href='{{ publickey.confirmation_document.url }}'>{% translate "Download" %}</a>
    {% if publickey.status == 'PENDING' %}
      <div class="alert alert-warning">
        The public key needs confirmation by the administration in order to be used. 
      </div>
    {% endif %}


  </div>
  <div class="col-md-6">
    
      <h5>Key text</h5>
      <code>
      <pre>
      {{ publickey.key }}
      </pre>
      </code>
    </div>
  </div>
</div>
<div class='row'>
  <div class='col-md-12'>
    <a class='btn btn-secondary' href='{% url "public_key_list" %}'>Return</a>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src='{% static "openpgp/openpgp.min.js" %}'></script>
<script>

const loadPK = (async(key_data) => {
    
    let publicKey = await openpgp.readKey({
        armoredKey: key_data
    });
    let fingerprint = publicKey.keyPacket.getFingerprint()
    
    return {key_data, fingerprint}
    
})

$(function() { 
  $('#validateButton').click(function() { 
    
    let keyVal = $('#id_key').val()
    
    loadPK(keyVal).then( ({key_data, fingerprint}) => {
      console.log(key_data, fingerprint)
      $('#id_fingerprint').val(fingerprint)
      $('#id_key').prop('readonly', true)
      $('#validateButton').prop('disabled', true)
      $('#submitButton').prop('disabled', false)
    }).catch(err => {
      bootstrap5Alert({'message': err, 'title': "ERROR"})
    })
  })

  $('#submitButton').click(function() { 
    $(this).closest('form').submit()
  })
})
</script>
{% endblock %}